# Лабораторная работа #3

![GitHub Classroom Workflow](../../workflows/GitHub%20Classroom%20Workflow/badge.svg?branch=master)

## Fault Tolerance

### Формулировка

На базе [Лабораторной работы #2](https://github.com/bmstu-rsoi/lab2-template) реализовать механизмы, увеличивающие
отказоустойчивость системы:

* На Gateway Service для _всех операций_ чтения реализовать паттерн Circuit Breaker. Накапливать статистику в памяти, и
  если система не ответила N раз, то в N+1 раз вместо запроса сразу отдавать fallback. Через небольшой timeout выполнить
  запрос к реальной системе, чтобы проверить ее состояние.
* В случае недоступности данных из некритичного источника (не основного), возвращается fallback-ответ. В зависимости от
  ситуации, это может быть:
    * пустой объект или массив;
    * объект, с заполненным полем (`uid` или подобным), по которому идет связь с другой системой;
    * default строка (если при этом не меняется тип переменной).
* В задании описаны две операции, изменяющие состояния нескольких систем. В случае недоступности одной из систем,
  участвующих в этой операции, выполнить:
    * откат всей операции;
    * возвращать пользователю ответ об успешном завершении операции, а на Gateway Service поставить этот запрос в
      очередь для повторного выполнения.

### Требования

1. Для автоматических прогонов тестов в файле [autograding.json](.github/classroom/autograding.json)
   и [classroom.yml](.github/workflows/classroom.yml) заменить `<variant>` на ваш вариант.
1. Код хранить на Github, для сборки использовать Github Actions.
1. Каждый сервис должен быть завернут в docker.
1. В classroom.yml дописать шаги на сборку, прогон unit-тестов.
1. Деплой каждого сервиса должен быть _только_ на Heroku.

### Пояснения

1. Для локальной разработки можно использовать Postgres в docker.
1. Схема взаимодействия сервисов остается как в Лабораторной работе #2.
1. Для реализации очереди можно использовать language native реализацию (например, BlockingQueue для Java), либо
   какую-то готовую реализацию типа RabbitMQ, Redis, ZeroMQ и т.п. Крайне нежелательно использовать реляционную базу
   данных как средство эмуляции очереди.
1. Для корректности реализации лабораторной выключается один сервис и проверяется корректность работы остальных. Для
   этого используется Heroku API, сервис переводится в Maintenance Mode. Для реализации этой операции в нужно в
   [classroom.yml](.github/workflows/classroom.yml) в блоке `Run API Tests`
   прописать переменные:
   ```
   envVar: '[{ "key": "serviceName", "value": "<Service Name>" }, { "key": "herokuApiToken", "value": "${{secrets.HEROKU_API_KEY}}" }]'
   ```
1. Чтобы `HEROKU_API_KEY` не зашивать в коде, его нужно прописать в `Settings` -> `Secrets`.
1. В переменную `serviceName` нужно прописать имя выключаемого (указан в вариантах задания) сервиса на Heroku.

### Прием задания

1. При получении задания у вас создается clone этого репозитория для вашего пользователя.
1. После того, как все тесты успешно завершатся, в Github Classroom на Dashboard будет отмечено успешное выполнение
   тестов.

### Варианты заданий

Распределение вариантов заданий аналогично [ЛР #2](https://github.com/bmstu-rsoi/lab2-template).

1. [Flight Booking System](v1/README.md)
1. [Hotels Booking System](v2/README.md)
1. [Car Rental System](v3/README.md)
1. [Library System](v4/README.md)
